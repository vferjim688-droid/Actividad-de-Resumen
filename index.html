<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad de Resumen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase (OBLIGATORIO) ---
        // Estas variables se proporcionan en el entorno de ejecución
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let aulaData = null;
        let apartadosGenerados = [];
        let apartadoActualIndex = 0;
        let alumnoId, aulaId;

        // --- Modelos de API (Gemini) ---
        // Debes reemplazar 'TU_API_KEY' por tu clave real de API de Google AI Studio
        // OJO: NUNCA expongas una API key en el lado del cliente en producción.
        // Esto es solo para prototipado. En producción, esto debe hacerse en un backend seguro.
        const API_KEY = ""; // DEJAR VACÍO.
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // --- Elementos de la UI ---
        const $ = (id) => document.getElementById(id);
        const loadingSpinner = $('loading-spinner');
        const appContainer = $('app-container');
        const errorContainer = $('error-container');
        const errorMessage = $('error-message');
        
        const pdfTitulo = $('pdf-titulo');
        const pdfTextoContainer = $('pdf-texto-container');
        const togglePdfButton = $('toggle-pdf-button');
        const pdfTexto = $('pdf-texto');
        
        const apartadoTitulo = $('apartado-titulo');
        const resumenTituloUsuario = $('resumen-titulo-usuario');
        const resumenTextoUsuario = $('resumen-texto-usuario');
        const evaluarResumenBtn = $('evaluar-resumen-btn');
        const iaFeedbackContainer = $('ia-feedback-container');
        const iaResumenGenerado = $('ia-resumen-generado');
        const iaEvaluacion = $('ia-evaluacion');
        const siguienteApartadoBtn = $('siguiente-apartado-btn');
        const barraProgreso = $('barra-progreso');

        // --- Lógica de la Aplicación ---

        window.onload = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                mostrarError("Error de Configuración", "La configuración de Firebase no se ha cargado correctamente.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticar al usuario
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // El usuario está autenticado, ahora iniciamos la carga de datos
                        await iniciarCargaDatos();
                    } else {
                        // Si no hay usuario, intentar autenticación anónima o con token
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            // onAuthStateChanged se disparará de nuevo
                        } catch (authError) {
                            console.error("Error de autenticación:", authError);
                            mostrarError("Error de Autenticación", "No se pudo verificar tu identidad.");
                        }
                    }
                });

            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
                mostrarError("Error de Inicialización", "No se pudo conectar con los servicios de la actividad.");
            }
        };

        /**
         * 1. Inicia la carga de datos después de la autenticación
         */
        async function iniciarCargaDatos() {
            // 1. Obtener parámetros de la URL
            const params = new URLSearchParams(window.location.search);
            aulaId = params.get('aulaId');
            alumnoId = params.get('alumnoId'); // Usamos el ID de alumno de la URL

            if (!aulaId || !alumnoId) {
                mostrarError("Faltan Datos", "No se ha especificado un aula o un alumno. Asegúrate de acceder desde el enlace correcto.");
                return;
            }

            // 2. Cargar datos del aula desde Firestore
            await cargarDatosAula(aulaId);
        }

        /**
         * 2. Carga los datos del aula (PDF, etc.) desde Firestore
         */
        async function cargarDatosAula(id) {
            try {
                const docPath = `/artifacts/${appId}/public/data/aulas/${id}`;
                const docRef = doc(db, docPath);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    aulaData = docSnap.data();
                    pdfTitulo.textContent = aulaData.pdfTitulo || "Actividad de Resumen";
                    pdfTexto.textContent = aulaData.pdfTextoCompleto || "No hay texto de PDF disponible.";
                    
                    // 3. Generar apartados con IA
                    await generarApartados(aulaData.pdfTextoCompleto);

                } else {
                    mostrarError("Aula no encontrada", `No se encontraron datos para el aula con ID: ${id}`);
                }
            } catch (e) {
                console.error("Error al cargar datos del aula:", e);
                mostrarError("Error de Carga", "No se pudieron cargar los datos del aula desde Firestore.");
            }
        }

        /**
         * 3. Llama a la API de IA para generar los apartados del PDF
         */
        async function generarApartados(textoPdf) {
            iaFeedbackContainer.innerHTML = '<p class="text-blue-600">Analizando el PDF y generando apartados con IA...</p>';
            
            const prompt = `
                Basado en el siguiente texto de un documento, divídelo en apartados o secciones lógicas clave para un resumen.
                Quiero que me devuelvas SOLAMENTE un array JSON, sin nada más antes o después.
                Cada objeto del array debe tener dos claves: "titulo" (un título corto para el apartado) y "contenido" (el fragmento de texto de ese apartado).
                
                Ejemplo de formato de respuesta:
                [
                    {"titulo": "Introducción al Tema", "contenido": "El texto de la introducción..."},
                    {"titulo": "Desarrollo Principal", "contenido": "El texto del desarrollo..."}
                ]

                Texto del documento:
                ---
                ${textoPdf}
                ---
            `;

            try {
                const generados = await callGeminiAPI(prompt, true);
                if (generados && generados.length > 0) {
                    apartadosGenerados = generados;
                    apartadoActualIndex = 0;
                    mostrarApartadoActual();
                    loadingSpinner.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    iaFeedbackContainer.innerHTML = ''; // Limpiar mensaje de carga
                } else {
                    throw new Error("La IA no devolvió apartados válidos.");
                }
            } catch (e) {
                console.error("Error al generar apartados:", e);
                // Fallback: si la IA falla, usar el texto completo como un solo apartado
                apartadosGenerados = [{
                    titulo: "Documento Completo",
                    contenido: textoPdf
                }];
                apartadoActualIndex = 0;
                mostrarApartadoActual();
                loadingSpinner.classList.add('hidden');
                appContainer.classList.remove('hidden');
                iaFeedbackContainer.innerHTML = '<p class="text-red-600">La IA no pudo dividir el texto; se cargará como un solo apartado.</p>';
            }
        }

        /**
         * 4. Muestra el apartado actual en la UI
         */
        function mostrarApartadoActual() {
            if (apartadoActualIndex >= apartadosGenerados.length) {
                finalizarActividad();
                return;
            }

            const apartado = apartadosGenerados[apartadoActualIndex];
            apartadoTitulo.textContent = `Apartado ${apartadoActualIndex + 1} de ${apartadosGenerados.length}: ${apartado.titulo}`;
            
            // Limpiar campos para el nuevo apartado
            resumenTituloUsuario.value = '';
            resumenTextoUsuario.value = '';
            iaFeedbackContainer.classList.add('hidden');
            iaResumenGenerado.innerHTML = '';
            iaEvaluacion.innerHTML = '';
            siguienteApartadoBtn.classList.add('hidden');
            evaluarResumenBtn.classList.remove('hidden');
            evaluarResumenBtn.disabled = false;

            // Actualizar barra de progreso
            const progreso = ((apartadoActualIndex + 1) / apartadosGenerados.length) * 100;
            barraProgreso.style.width = `${progreso}%`;
        }

        /**
         * 5. Lógica del botón de Evaluación
         */
        async function handleEvaluarResumen() {
            const titulo = resumenTituloUsuario.value.trim();
            const texto = resumenTextoUsuario.value.trim();
            const lineas = texto.split('\n').filter(line => line.trim() !== '');

            // Validaciones
            if (titulo === "") {
                mostrarErrorTemporal("Falta el título", "Debes poner un título a tu resumen antes de evaluar.");
                return;
            }
            if (lineas.length < 5) {
                mostrarErrorTemporal("Resumen muy corto", `Tu resumen debe tener al menos 5 líneas. Actualmente tienes ${lineas.length}.`);
                return;
            }

            evaluarResumenBtn.disabled = true;
            evaluarResumenBtn.textContent = "Evaluando con IA...";
            iaFeedbackContainer.classList.remove('hidden');
            iaResumenGenerado.innerHTML = '<p class="text-blue-600">Generando resumen de referencia...</p>';
            iaEvaluacion.innerHTML = '<p class="text-blue-600">Evaluando tu aporte...</p>';

            const contenidoApartado = apartadosGenerados[apartadoActualIndex].contenido;

            try {
                // --- Tarea 1: Generar Resumen de Referencia (como pediste) ---
                const promptResumen = `
                    Genera un resumen conciso y claro del siguiente texto. 
                    Este resumen servirá como referencia para un estudiante.
                    
                    Texto a resumir:
                    ---
                    ${contenidoApartado}
                    ---
                `;
                const resumenIA = await callGeminiAPI(promptResumen);
                iaResumenGenerado.innerHTML = `
                    <h4 class="font-semibold text-gray-700 mb-2">Resumen de Referencia (IA):</h4>
                    <p class="text-gray-600 text-sm">${resumenIA}</p>
                `;

                // --- Tarea 2: Evaluar el Resumen del Alumno ---
                const promptEvaluacion = `
                    Eres un profesor asistente. Un estudiante te ha entregado un resumen de un texto.
                    Quiero que evalúes el resumen del estudiante comparándolo con el texto original.
                    
                    Tu evaluación debe ser constructiva y seguir esta estructura:
                    1.  **Puntos Fuertes:** Qué hizo bien el estudiante (ej. captó la idea principal, buena síntesis).
                    2.  **Puntos de Mejora:** Qué faltó o qué se puede explicar mejor (ej. faltaron detalles clave, se desvió del tema).
                    3.  **Sugerencia:** Un consejo para mejorar.
                    
                    TEXTO ORIGINAL (del apartado):
                    ---
                    ${contenidoApartado}
                    ---
                    
                    RESUMEN DEL ESTUDIANTE (Título: ${titulo}):
                    ---
                    ${texto}
                    ---
                `;
                const evaluacionIA = await callGeminiAPI(promptEvaluacion);
                iaEvaluacion.innerHTML = `
                    <h4 class="font-semibold text-gray-700 mt-4 mb-2">Evaluación de tu Resumen (IA):</h4>
                    <div class="text-gray-600 text-sm whitespace-pre-wrap">${evaluacionIA}</div>
                `;

                // Guardar progreso en Firestore (opcional pero recomendado)
                guardarProgresoEnFirestore(apartadoActualIndex, titulo, texto, evaluacionIA);

                // Mostrar botón de siguiente
                evaluarResumenBtn.classList.add('hidden');
                siguienteApartadoBtn.classList.remove('hidden');

            } catch (e) {
                console.error("Error en la evaluación con IA:", e);
                iaFeedbackContainer.innerHTML = `<p class="text-red-600">Error al contactar con la IA. Inténtalo de nuevo.</p>`;
                evaluarResumenBtn.disabled = false;
            } finally {
                evaluarResumenBtn.textContent = "Autoevaluar con IA";
            }
        }

        /**
         * 6. Guardar el progreso del alumno en Firestore
         */
        async function guardarProgresoEnFirestore(index, tituloResumen, textoResumen, evaluacion) {
            try {
                // Ruta: /artifacts/{appId}/public/data/aulas/{aulaId}/alumnos/{alumnoId}/progresos/{apartadoIndex}
                const docPath = `/artifacts/${appId}/public/data/aulas/${aulaId}/alumnos/${alumnoId}/progresos/${index}`;
                await setDoc(doc(db, docPath), {
                    apartadoTitulo: apartadosGenerados[index].titulo,
                    resumenTitulo: tituloResumen,
                    resumenTexto: textoResumen,
                    evaluacionIA: evaluacion,
                    timestamp: new Date()
                });
            } catch (e) {
                console.warn("No se pudo guardar el progreso en Firestore:", e);
                // No es un error crítico, el alumno puede continuar
            }
        }

        /**
         * 7. Finalizar la actividad
         */
        function finalizarActividad() {
            appContainer.innerHTML = `
                <div class="text-center p-8 bg-white rounded-lg shadow-xl">
                    <h2 class="text-3xl font-bold text-green-600 mb-4">¡Actividad Completada!</h2>
                    <p class="text-lg text-gray-700">Has finalizado todos los apartados de resumen para el documento:</p>
                    <p class="text-xl font-semibold text-blue-800 mt-2">${aulaData.pdfTitulo}</p>
                    <p class="mt-6 text-gray-600">Puedes cerrar esta ventana. Tu progreso ha sido guardado.</p>
                </div>
            `;
        }


        // --- Funciones de Utilidad ---

        /**
         * Función central para llamar a la API de Gemini
         */
        async function callGeminiAPI(prompt, expectJson = false) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: expectJson ? { responseMimeType: "application/json" } : {}
            };

            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Error de la API: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (!result.candidates || !result.candidates[0].content) {
                 throw new Error("Respuesta inesperada de la API de Gemini.");
            }

            const text = result.candidates[0].content.parts[0].text;
            
            if (expectJson) {
                try {
                    // Limpiar el texto si la API envuelve el JSON en markdown
                    const cleanedText = text.replace(/^```json\n/, '').replace(/\n```$/, '');
                    return JSON.parse(cleanedText);
                } catch (e) {
                    console.error("La IA no devolvió un JSON válido:", text);
                    throw new Error("La IA no devolvió un JSON válido.");
                }
            } else {
                return text;
            }
        }

        function mostrarError(titulo, mensaje) {
            loadingSpinner.classList.add('hidden');
            appContainer.classList.add('hidden');
            errorContainer.classList.remove('hidden');
            errorMessage.innerHTML = `<strong>${titulo}</strong><br>${mensaje}`;
        }

        function mostrarErrorTemporal(titulo, mensaje) {
            // Esta función podría mostrar un modal temporal
            // Por ahora, usamos un alert simple (aunque no ideal)
            alert(`${titulo}: ${mensaje}`);
        }

        // --- Event Listeners de la UI ---
        togglePdfButton.addEventListener('click', () => {
            pdfTextoContainer.classList.toggle('hidden');
            togglePdfButton.textContent = pdfTextoContainer.classList.contains('hidden') 
                ? 'Mostrar Texto del PDF' 
                : 'Ocultar Texto del PDF';
        });

        evaluarResumenBtn.addEventListener('click', handleEvaluarResumen);
        
        siguienteApartadoBtn.addEventListener('click', () => {
            apartadoActualIndex++;
            mostrarApartadoActual();
        });

    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para el contenedor del PDF */
        #pdf-texto-container {
            max-height: 300px; /* Altura máxima inicial */
            transition: max-height 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- 1. Estado de Carga -->
    <div id="loading-spinner" class="text-center">
        <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg text-gray-700 font-semibold">Cargando actividad...</p>
        <p class="text-gray-500">Preparando tu entorno de resumen.</p>
    </div>

    <!-- 2. Estado de Error -->
    <div id="error-container" class="hidden bg-white p-8 rounded-lg shadow-xl max-w-md w-full text-center">
        <h2 class="text-2xl font-bold text-red-600 mb-4">Ha ocurrido un error</h2>
        <p id="error-message" class="text-gray-700"></p>
    </div>

    <!-- 3. Contenedor Principal de la Aplicación -->
    <div id="app-container" class="hidden max-w-4xl w-full bg-white rounded-lg shadow-2xl overflow-hidden">
        
        <!-- Cabecera y Progreso -->
        <header class="p-6 border-b border-gray-200">
            <h1 id="pdf-titulo" class="text-2xl font-bold text-gray-800 text-center">Cargando título...</h1>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                <div id="barra-progreso" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </header>

        <!-- Cuerpo Principal (PDF y Resumen) -->
        <div class="p-6 md:p-8 grid md:grid-cols-2 gap-8">

            <!-- Columna Izquierda: PDF y Apartado -->
            <div class="flex flex-col space-y-4">
                <button id="toggle-pdf-button" class="w-full text-left font-semibold text-blue-600 hover:text-blue-800">
                    Ocultar Texto del PDF
                </button>
                <div id="pdf-texto-container" class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-y-auto">
                    <pre id="pdf-texto" class="text-sm text-gray-600 whitespace-pre-wrap font-sans">Cargando texto...</pre>
                </div>
                
                <div class="mt-4">
                    <h3 id="apartado-titulo" class="text-lg font-semibold text-gray-800 mb-2">Cargando apartado...</h3>
                    <p class="text-sm text-gray-500">Lee el texto del PDF (o el contenido específico del apartado si la IA lo ha dividido) y crea tu resumen a continuación.</p>
                </div>
            </div>

            <!-- Columna Derecha: Input del Alumno y Feedback IA -->
            <div class="flex flex-col space-y-4">
                <h3 class="text-lg font-semibold text-gray-800">Tu Resumen del Apartado</h3>
                
                <!-- Título del Resumen del Alumno -->
                <div>
                    <label for="resumen-titulo-usuario" class="block text-sm font-medium text-gray-700">Título de tu Resumen</label>
                    <input type="text" id="resumen-titulo-usuario" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: Ideas Principales de la Introducción">
                </div>
                
                <!-- Texto del Resumen del Alumno -->
                <div>
                    <label for="resumen-texto-usuario" class="block text-sm font-medium text-gray-700">Tu Resumen (mínimo 5 líneas)</label>
                    <textarea id="resumen-texto-usuario" rows="8" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Escribe tu síntesis aquí..."></textarea>
                </div>

                <!-- Botones de Acción -->
                <button id="evaluar-resumen-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                    Autoevaluar con IA
                </button>
                <button id="siguiente-apartado-btn" class="hidden w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                    Siguiente Apartado &rarr;
                </button>

                <!-- Contenedor de Feedback de la IA -->
                <div id="ia-feedback-container" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div id="ia-resumen-generado">
                        <!-- El resumen de referencia de la IA se cargará aquí -->
                    </div>
                    <div id="ia-evaluacion" class="mt-4">
                        <!-- La evaluación del alumno se cargará aquí -->
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
